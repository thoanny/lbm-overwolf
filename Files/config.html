<!DOCTYPE html>
<html>
	<head>
		<link rel="stylesheet" href="css/style.min.css" />
    <script src="js/main.min.js"></script>
		<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
		<title>Le Bus Magique</title>
	</head>

	<body class="config">
		<div class="resizeGrip" id="resizeGripBottom" onmousedown="dragResize('Bottom');"></div>

		<div id="content">

			<header>
				<button id="close" onclick="closeWindow();"><i class="fa fa-times" aria-hidden="true"></i></button>
				<div id="drag" onmousedown="dragMove();"></div>
			</header>

			<div id="page">
				<div class="container">
					<h2>Configuration</h2>

		      <form id="config" autocomplete="off">
		        <fieldset>
		          <legend>API</legend>
		          <p>
		            <label for="api_key">Clé API</label>
		            <input type="text" id="api_key" />
		            <input type="hidden" id="permissions" />
		            <span class="error" style="display:none;">Erreur</span>
		          </p>
		          <ul id="permissions" class="fa-ul">
		            <li class="account"><i class="fa-li fa fa-square"></i> account</li>
		            <li class="inventories"><i class="fa-li fa fa-square"></i> inventories</li>
		            <li class="characters"><i class="fa-li fa fa-square"></i> characters</li>
		            <li class="tradingpost"><i class="fa-li fa fa-square"></i> tradingpost</li>
		            <li class="wallet"><i class="fa-li fa fa-square"></i> wallet</li>
		            <li class="unlocks"><i class="fa-li fa fa-square"></i> unlocks</li>
		            <li class="pvp"><i class="fa-li fa fa-square"></i> pvp</li>
		            <li class="builds"><i class="fa-li fa fa-square"></i> builds</li>
		            <li class="progression"><i class="fa-li fa fa-square"></i> progression</li>
		            <li class="guilds"><i class="fa-li fa fa-square"></i> guilds</li>
		          </ul>
		        </fieldset>
		        <fieldset>
		          <legend>Compte</legend>
		          <p>
		            <label>Nom de compte</label>
		            <input type="text" id="account_name" disabled="disabled" />
		          </p>
		        </fieldset>
		        <fieldset>
		          <legend>Guilde</legend>
		          <p>
		            <label>Guilde représentée</label>
		            <select id="favorite_guild">
		              <option value="">Aucun guilde connue</option>
		            </select>
		          </p>
		        </fieldset>
		        <p>
							<input type="hidden" id="account_id" />
							<input type="hidden" id="high_level" />
							<input type="hidden" id="account_access" />
		          <button type="submit">Enregistrer les modifications</button>
		        </p>
		      </form>
				</div>
			</div>



      <script>

      var config_favorite_guild = getConfig('favorite_guild');

      if(getConfig('api_key')) {
        var api_key = getConfig('api_key');
        $('input#api_key').val(api_key);

        $.getJSON('https://api.guildwars2.com/v2/tokeninfo?access_token='+api_key, function(data) {
          $('input#permissions').val(JSON.stringify(data.permissions));
          $.each(data.permissions, function(i, j) {
            $("#permissions li."+j+" i.fa-li").removeClass('fa-square').addClass('fa-check-square');
  			  });
        }).fail(function(error) {
			    if(error.status == 403) {
						$('input#api_key').addClass('error');
		          deleteConfig('permissions');
		          deleteConfig('account_name');
		          deleteConfig('account_id');
		          deleteConfig('high_level');
		          deleteConfig('account_access');
							deleteConfig('favorite_guild');
					}
			  });

        $.getJSON('https://api.guildwars2.com/v2/account?access_token='+api_key, function(data) {
          $('input#account_access').val(data.access);
          $('input#account_name').val(data.name);
          $('input#account_id').val(data.id);

					$('select#favorite_guild').html('<option value="">-- Choisissez une guilde --</option>');

					$.each(data.guilds, function(i, j) {

            $.getJSON('https://api.guildwars2.com/v2/guild/'+ j, function(data) {

							var selected = '';
              if(config_favorite_guild && config_favorite_guild == data.tag) {
                selected = ' selected="selected"'
              }
              $('select#favorite_guild').append('<option value="'+data.tag+'"'+selected+'>['+data.tag+'] '+data.name+'</option>');

            });

  			  });

        });

        $.getJSON('https://api.guildwars2.com/v2/characters?access_token='+api_key, function(data) {
					var high_level = 0;

          $.each(data, function(i, j) {

            $.getJSON('https://api.guildwars2.com/v2/characters/'+ j.replace(' ', '%20') +'?lang=fr&access_token='+api_key, function(data) {

							if(high_level < data.level) {
								high_level = data.level;
								$('input#high_level').val(high_level);
							}

            });

  			  });

        });

      }

			$( "input#api_key" ).focus(function() {
				if( $(this).hasClass('error') ) {
					$(this).removeClass('error');
				}
			});

      $('form#config').submit(function(e){
        var $api_key = $('input#api_key'),
            $high_level = $('input#high_level'),
            $permissions = $('input#permissions'),
            $account_name = $('input#account_name'),
            $account_id = $('input#account_id'),
            $account_access = $('input#account_access'),
            $favorite_guild = $('select#favorite_guild'),
						$button = $('button[type="submit"]');

				$button.find('i').remove();
				$button.prepend('<i class="fa fa-spinner fa-pulse"></i> ');

        if($api_key.val() == '') {
          $api_key.next('.error').show();
					deleteConfig('api_key');
        } else {
          $api_key.next('.error').hide();
          setConfig('api_key', $api_key.val());
        }

        if($permissions.val() !== '') {
          setConfig('permissions', $permissions.val());
        }

        if($account_name.val() !== '') {
          setConfig('account_name', $account_name.val());
        }

        if($account_id.val() !== '') {
          setConfig('account_id', $account_id.val());
        }

        if($high_level.val() !== '') {
          setConfig('high_level', $high_level.val());
        }

				if($account_access.val() !== '') {
          setConfig('account_access', $account_access.val());
        }

				if($favorite_guild.val() !== '') {
          setConfig('favorite_guild', $favorite_guild.val());
        } else {
					deleteConfig('favorite_guild');
				}

				$button.find('i').removeClass('fa-spinner').removeClass('fa-pulse').addClass('fa-check-circle');
				location.reload();

        return false;
      });
      </script>

		</div>
	</body>
</html>
